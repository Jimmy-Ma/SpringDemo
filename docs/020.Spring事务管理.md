# 020.Spring事务管理

## 一、事务简介

* 事务管理是企业级应用程序开发中必不可少的技术, 用来确保数据的完整性和一致性. 


* 事务就是一系列的动作, 它们被当做一个单独的工作单元. 这些动作要么全部完成, 要么全部不起作用


* 事务的四个关键属性(ACID)
* 1.原子性(atomicity): 事务是一个原子操作, 由一系列动作组成. 事务的原子性确保动作要么全部完成要么完全不起作用.
* 2.一致性(consistency): 一旦所有事务动作完成, 事务就被提交. 数据和资源就处于一种满足业务规则的一致性状态中.
* 3.隔离性(isolation): 可能有许多事务会同时处理相同的数据, 因此每个事物都应该与其他事务隔离开来, 防止数据损坏.
* 4.持久性(durability): 一旦事务完成, 无论发生什么系统错误, 它的结果都不应该受到影响. 通常情况下, 事务的结果被写到持久化存储器中.


## 二、准备

* Dao

		package com.jimmy.spring.tx;
		
		import org.springframework.beans.factory.annotation.Autowired;
		import org.springframework.jdbc.core.JdbcTemplate;
		import org.springframework.stereotype.Repository;
		
		@Repository("bookShopDao")
		public class BookShopDaoImpl implements BookShopDao {
		
			@Autowired
			private JdbcTemplate jdbcTemplate;
			
			@Override
			public int findBookPriceByIsbn(String isbn) {
				String sql = "SELECT price FROM book where isbn = ?";
				int price = jdbcTemplate.queryForObject(sql, Integer.class, isbn);
				return price;
			}
		
			@Override
			public void updateBookStock(String isbn) {
				int stock = findBookStockByIsbn(isbn);
				if (stock == 0){
					throw new BookStockException("库存不足");
				}
				
				String sql = "UPDATE book_stock SET stock = stock-1 WHERE isbn = ?";
				jdbcTemplate.update(sql, isbn);
			}
		
			@Override
			public void updateAccount(String username, int price) {
				int balance = findUsernameBalanceByUsername(username);
				if (balance < price){
					throw new UserAccountException("余额不足");
				}
				
				String sql = "UPDATE account SET balance = balance-? WHERE username = ?";
				jdbcTemplate.update(sql, price, username);
			}
			
			public int findBookStockByIsbn(String isbn){
				String sql = "SELECT stock FROM book_stock where isbn = ?";
				int stock = jdbcTemplate.queryForObject(sql, Integer.class, isbn);
				return stock;
			}
			
			public int findUsernameBalanceByUsername(String username){
				String sql = "SELECT balance FROM account where username = ?";
				int balance = jdbcTemplate.queryForObject(sql, Integer.class, username);
				return balance;
			}
		
		}

* Service

		package com.jimmy.spring.tx;
		
		import org.springframework.beans.factory.annotation.Autowired;
		import org.springframework.stereotype.Service;
		
		@Service("bookShopService")
		public class BookShopServiceImpl implements BookShopService {
		
			@Autowired
			private BookShopDao bookShopDao; 
			
			@Override
			public void purchase(String isbn, String username) {
				//查询书的价格
				int price = bookShopDao.findBookPriceByIsbn(isbn);
				//更新书的库存
				bookShopDao.updateBookStock(isbn);
				//更新用户余额
				bookShopDao.updateAccount(username, price);
			}
		}

* Spring Bean配置文件

		<context:component-scan base-package="com.jimmy.spring.tx"></context:component-scan>
	
		<context:property-placeholder location="classpath:db.properties"/>
		
		<bean id="dataSource" class="com.mchange.v2.c3p0.ComboPooledDataSource">
			<property name="user" value="${user}"></property>
			<property name="password" value="${password}"></property>
			<property name="driverClass" value="${driverClass}"></property>
			<property name="jdbcUrl" value="${jdbcUrl}"></property>
			
			<property name="initialPoolSize" value="${initialPoolSize}"></property>
			<property name="maxPoolSize" value="${maxPoolSize}"></property>
		</bean>
		
		<bean id="jdbcTemplate" class="org.springframework.jdbc.core.JdbcTemplate">
			<constructor-arg ref="dataSource"></constructor-arg>
		</bean>

## 三、Spring中的事务管理

* 作为企业级应用程序框架, Spring 在不同的事务管理 API 之上定义了一个抽象层. 而应用程序开发人员不必了解底层的事务管理 API, 就可以使用 Spring 的事务管理机制.


* Spring 既支持编程式事务管理, 也支持声明式的事务管理.


* 编程式事务管理: 将事务管理代码嵌入到业务方法中来控制事务的提交和回滚. 在编程式管理事务时, 必须在每个事务操作中包含额外的事务管理代码.

 
* 声明式事务管理: 大多数情况下比编程式事务管理更好用. 它将事务管理代码从业务方法中分离出来, 以声明的方式来实现事务管理. 事务管理作为一种横切关注点, 可以通过 AOP 方法模块化. Spring 通过 Spring AOP 框架支持声明式事务管理.


* Spring 从不同的事务管理 API 中抽象了一整套的事务机制. 开发人员不必了解底层的事务 API, 就可以利用这些事务机制. 有了这些事务机制, 事务管理代码就能独立于特定的事务技术了.


* Spring 的核心事务管理抽象是它为事务管理封装了一组独立于技术的方法. 无论使用 Spring 的哪种事务管理策略(编程式或声明式), 事务管理器都是必须的.


## 四、声明式事务管理

* Spring配置文件

		<!-- 配置事务管理器 -->
		<bean id="transactionManager" 
			class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
			<property name="dataSource" ref="dataSource"></property>
		</bean>
		
		<!-- 启用事务注解 -->
		<tx:annotation-driven transaction-manager="transactionManager"/>

* 事务注解

		@Transactional
		public void purchase(String isbn, String username) {
